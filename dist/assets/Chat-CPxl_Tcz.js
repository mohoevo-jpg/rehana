import{r as g,u as K,s as Z,g as j,h as P,E as A,c as n,b as e,t as c,G as Q,k as v,n as f,j as x,F as V,m as E,p as W,q as X,d as Y,w as ee,e as te,v as se,o as l,K as L}from"./index-DUS2SrFg.js";import{u as ae}from"./branches-C78i2SSd.js";import{a as re}from"./date-CbKvo9xS.js";import{S as $,a as F}from"./store-M-edT6Yy.js";import{U as oe}from"./user-GOvdep_U.js";import{T as le}from"./trash-2-DjMAfoaB.js";import{c as ne}from"./createLucideIcon-Dlap17QE.js";import"./format-MhD4UfPn.js";import"./en-US-dIBtKp69.js";import"./ar-YW_Uz9wj.js";/**
 * @license lucide-vue-next v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=ne("MicIcon",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);class de{constructor(){this.messages=g([]),this.currentUser=null,window.addEventListener("storage",u=>{u.key==="chat_messages"&&this.loadMessages()})}init(u){this.currentUser=u,this.loadMessages()}loadMessages(){const u=localStorage.getItem("chat_messages");u&&(this.messages.value=JSON.parse(u))}sendMessage(u,I=null,M="text",y=null){const m={id:Date.now(),text:u,type:M,mediaUrl:y,senderId:this.currentUser.id,senderName:this.currentUser.name,timestamp:new Date().toISOString(),recipientId:I,branch:"الفرع الرئيسي"},h=[...this.messages.value,m];this.messages.value=h,localStorage.setItem("chat_messages",JSON.stringify(h))}getMessages(){return this.messages}}const S=new de,ce={class:"flex h-full bg-white rounded-lg shadow-lg overflow-hidden"},ue={class:"w-64 border-l bg-gray-50 flex flex-col"},ve={class:"p-4 border-b bg-white"},me={class:"flex items-center gap-3 mb-2"},pe={class:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-bold"},ge={class:"overflow-hidden"},he={class:"font-bold text-gray-900 truncate"},fe={class:"text-xs text-gray-500"},xe={class:"flex-1 overflow-y-auto p-2 space-y-4"},ye={class:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"},be={class:"space-y-1"},_e=["onClick"],we={class:"relative"},ke={class:"w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium text-xs"},Se={class:"font-medium text-sm truncate"},Ie={class:"flex-1 flex flex-col min-w-0"},Me={class:"p-4 border-b bg-white flex justify-between items-center shadow-sm z-10"},Ce={class:"flex items-center gap-3"},Ue={class:"font-bold text-gray-900"},Te={class:"text-xs text-gray-500"},De={key:0,class:"text-center text-gray-400 mt-10"},Be={class:"text-xs text-gray-500 mb-1 px-1"},Ne={key:0,class:"flex items-center gap-2 min-w-[240px]"},Re=["src"],je={key:1},Ae={class:"text-[10px] text-gray-400 mt-1 px-1"},Ve={class:"p-4 bg-white border-t"},Ee={key:0,class:"flex items-center gap-4 bg-red-50 p-2 rounded-full px-4 border border-red-100"},Le={class:"text-red-600 font-mono flex-1 text-left",dir:"ltr"},$e=["disabled"],Qe={__name:"Chat",setup(O){const u=K(),I=Z(),M=ae(),y=S.getMessages(),m=g(""),h=g(null),r=g(null),C=g(!1),b=g(0),o=g(null),_=g([]);let B=null;const z=s=>{const a=Math.floor(s/60),p=s%60;return`${a.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`},J=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0});o.value=new MediaRecorder(s),_.value=[],o.value.ondataavailable=a=>{_.value.push(a.data)},o.value.start(),C.value=!0,b.value=0,B=setInterval(()=>{b.value++},1e3)}catch(s){console.error("Error accessing microphone:",s),alert("لا يمكن الوصول إلى الميكروفون. الرجاء التحقق من الصلاحيات.")}},q=()=>{o.value&&(o.value.onstop=()=>{const s=o.value.mimeType||"audio/webm",a=new Blob(_.value,{type:s}),p=new FileReader;p.readAsDataURL(a),p.onloadend=()=>{const w=p.result,k=r.value?r.value.id:null;S.sendMessage("رسالة صوتية",k,"audio",w)},N()},o.value.stop())},G=()=>{o.value&&o.value.state!=="inactive"&&o.value.stop(),N()},N=()=>{C.value=!1,b.value=0,clearInterval(B),o.value&&(o.value.stream.getTracks().forEach(s=>s.stop()),o.value=null),_.value=[]},i=j(()=>u.currentUser),U=j(()=>r.value?y.value.filter(s=>s.senderId===i.value.id&&s.recipientId===r.value.id||s.senderId===r.value.id&&s.recipientId===i.value.id):y.value.filter(s=>!s.recipientId)),T=()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)};P(()=>{i.value&&(S.init(i.value),T())}),A(U,()=>{L(()=>T())},{deep:!0}),A(r,()=>{L(()=>T())});const H=()=>{if(!m.value.trim())return;const s=r.value?r.value.id:null;S.sendMessage(m.value,s),m.value=""};return(s,a)=>{var p,w,k;return l(),n("div",ce,[e("div",ue,[e("div",ve,[e("div",me,[e("div",pe,c((p=i.value)==null?void 0:p.name.charAt(0)),1),e("div",ge,[e("h3",he,c((w=i.value)==null?void 0:w.name),1),a[2]||(a[2]=e("p",{class:"text-xs text-green-600 flex items-center gap-1"},[e("span",{class:"w-2 h-2 rounded-full bg-green-500"}),Q(" متصل ")],-1))])]),e("p",fe,c(((k=v(M).branches.find(t=>{var d;return t.id===((d=i.value)==null?void 0:d.branchId)}))==null?void 0:k.name)||"الفرع غير محدد"),1)]),e("div",xe,[e("div",null,[e("button",{onClick:a[0]||(a[0]=t=>r.value=null),class:f(["w-full flex items-center gap-3 p-2 rounded-lg transition-colors",r.value?"hover:bg-gray-100 text-gray-700":"bg-primary-50 text-primary-700"])},[e("div",ye,[x(v($),{class:"w-4 h-4"})]),a[3]||(a[3]=e("span",{class:"font-medium text-sm"},"القناة العامة",-1))],2)]),e("div",null,[a[5]||(a[5]=e("h4",{class:"px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2"},"الموظفين",-1)),e("div",be,[(l(!0),n(V,null,E(v(I).users.filter(t=>{var d;return t.id!==((d=i.value)==null?void 0:d.id)}),t=>{var d;return l(),n("button",{key:t.id,onClick:D=>r.value=t,class:f(["w-full flex items-center gap-3 p-2 rounded-lg transition-colors",((d=r.value)==null?void 0:d.id)===t.id?"bg-primary-50 text-primary-700":"hover:bg-gray-100 text-gray-700"])},[e("div",we,[e("div",ke,c(t.name.charAt(0)),1),a[4]||(a[4]=e("div",{class:"absolute bottom-0 right-0 w-2 h-2 bg-green-400 border border-white rounded-full"},null,-1))]),e("span",Se,c(t.name),1)],10,_e)}),128))])])])]),e("div",Ie,[e("div",Me,[e("div",Ce,[e("div",{class:f(["w-10 h-10 rounded-full flex items-center justify-center",r.value?"bg-indigo-100 text-indigo-600":"bg-primary-100 text-primary-600"])},[(l(),W(X(r.value?v(oe):v($)),{class:"w-5 h-5"}))],2),e("div",null,[e("h2",Ue,c(r.value?r.value.name:"القناة العامة"),1),e("p",Te,c(r.value?"متصل":"متصل: جميع الفروع"),1)])])]),e("div",{class:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50",ref_key:"messagesContainer",ref:h},[U.value.length===0?(l(),n("div",De," لا توجد رسائل بعد ")):Y("",!0),(l(!0),n(V,null,E(U.value,t=>{var d,D,R;return l(),n("div",{key:t.id,class:f(["flex flex-col max-w-[70%]",t.senderId===((d=i.value)==null?void 0:d.id)?"self-end items-end":"self-start items-start"])},[e("span",Be,c(t.senderId===((D=i.value)==null?void 0:D.id)?"أنت":t.senderName),1),e("div",{class:f(["p-3 rounded-2xl shadow-sm text-sm break-words",t.senderId===((R=i.value)==null?void 0:R.id)?"bg-primary-600 text-white rounded-tl-none":"bg-white text-gray-800 rounded-tr-none"])},[t.type==="audio"?(l(),n("div",Ne,[e("audio",{controls:"",src:t.mediaUrl,class:"w-full h-8"},null,8,Re)])):(l(),n("span",je,c(t.text),1))],2),e("span",Ae,c(v(re)(t.timestamp)),1)],2)}),128))],512),e("div",Ve,[C.value?(l(),n("div",Ee,[a[6]||(a[6]=e("div",{class:"w-3 h-3 bg-red-500 rounded-full animate-pulse"},null,-1)),e("span",Le,c(z(b.value)),1),e("button",{onClick:G,class:"p-2 text-gray-500 hover:text-red-600 hover:bg-red-100 rounded-full transition-colors",title:"إلغاء"},[x(v(le),{class:"w-5 h-5"})]),e("button",{onClick:q,class:"p-2 bg-primary-600 text-white rounded-full hover:bg-primary-700 transition-colors shadow-sm",title:"إرسال"},[x(v(F),{class:"w-5 h-5"})])])):(l(),n("form",{key:1,onSubmit:ee(H,["prevent"]),class:"flex gap-2"},[te(e("input",{"onUpdate:modelValue":a[1]||(a[1]=t=>m.value=t),type:"text",placeholder:"اكتب رسالتك هنا...",class:"flex-1 px-4 py-2 border rounded-full focus:ring-2 focus:ring-primary-500 focus:outline-none bg-gray-50"},null,512),[[se,m.value]]),m.value.trim()?(l(),n("button",{key:1,type:"submit",disabled:!m.value.trim(),class:"p-2 bg-primary-600 text-white rounded-full hover:bg-primary-700 disabled:opacity-50 transition-colors"},[x(v(F),{class:"w-5 h-5"})],8,$e)):(l(),n("button",{key:0,type:"button",onClick:J,class:"p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors hover:text-primary-600",title:"تسجيل صوتي"},[x(v(ie),{class:"w-5 h-5"})]))],32))])])])}}};export{Qe as default};
